AC.namespace("AC.MaskedImage");AC.MaskedImage.version="1.0";AC.MaskedImage.Image=AC.Class({initialize:function ac_initialize(a){this._canvasElement=a;this._imageSrc=a.getAttribute("data-image-src");this._maskSrc=a.getAttribute("data-mask-src");this._mainImage=new Image();this._maskImage=new Image();this._maskCanvas=document.createElement("canvas");this._loadedImageCount=0;this._cssMaskElement=null;this._pixelRatio=1;this._fellBackToPNG=false;if((!this._imageSrc)||(!this._maskSrc)||(!a.getAttribute("data-fallback-src"))){throw"Masked canvas elements must include data-image-src, data-mask-src, and data-fallback-src attributes."}this._imageSrc=this._imageSrc.replace(/^https?:\/\/[^\/]+\//i,"../../index.html");this._maskSrc=this._maskSrc.replace(/^https?:\/\/[^\/]+\//i,"../../index.html");AC.Object.synthesize(this);if(this.fallback()){return}this._mainImage.onload=this.__handleImageLoad.bind(this);this._maskImage.onload=this.__handleImageLoad.bind(this);this._mainImage.onerror=this.__handleImageError.bind(this);this._maskImage.onerror=this.__handleImageError.bind(this);if(AC.Retina&&AC.Retina.sharedInstance().shouldReplace("img-tag")){this.upgradeSourcesForRetina()}else{this._mainImage.src=this._imageSrc;this._maskImage.src=this._maskSrc}},__handleImageLoad:function ac___handleImageLoad(){if(++this._loadedImageCount===2){this.draw()}},__handleImageError:function ac___handleImageError(a){throw"Could not load image at "+a.target.src},fallback:function ac_fallback(){if(AC.Environment.Feature.supportsCanvas()){return false}var c=this.canvasElement().getAttribute("data-fallback-src");if(c){var b=document.createElement("img");var a=this.canvasElement().className;b.src=c;b.width=this.canvasElement().getAttribute("width")||"";b.height=this.canvasElement().getAttribute("height")||"";this.canvasElement().parentNode.insertBefore(b,this.canvasElement());this.canvasElement().parentNode.removeChild(this.canvasElement());if(a&&a.match(/\S/)){a.split(/\s+/).forEach(function(d){AC.Element.addClassName(b,d)})}}this.setFellBackToPNG(true);return true},upgradeSourcesForRetina:function ac_upgradeSourcesForRetina(){this.setLoadedImageCount(0);this.setPixelRatio(2);this.canvasElement().style.width=(this.canvasElement().width)+"px";this.canvasElement().style.height=(this.canvasElement().height)+"px";this.setImageSrc(this.imageSrc().replace(/\.([^\.]+)$/,"_2x.$1"));this.setMaskSrc(this.maskSrc().replace(/\.([^\.]+)$/,"_2x.$1"));this.mainImage().src=this.imageSrc();this.maskImage().src=this.maskSrc()},draw:function ac_draw(){var d;var c=this.canvasElement().getContext("2d");var f=this.maskCanvas().getContext("2d");var a=this.mainImage().width*this.mainImage().height;this.canvasElement().width=this.mainImage().width;this.canvasElement().height=this.mainImage().height;this.maskCanvas().width=this.mainImage().width;this.maskCanvas().height=this.mainImage().height;f.drawImage(this.maskImage(),0,0);c.drawImage(this.mainImage(),0,0);var b=c.getImageData(0,0,this.mainImage().width,this.mainImage().height);var e=f.getImageData(0,0,this.mainImage().width,this.mainImage().height);for(d=0;d<a;d+=1){b.data[(d*4)+3]=(255-e.data[d*4])}c.putImageData(b,0,0)}});AC.MaskedImage.Manager=AC.Class({__instantiateOnDOMReady:true,initialize:function ac_initialize(){this._maskedImages=[];this._maskedCanvasElements=[];AC.Object.synthesize(this);this.findNewMaskedCanvases();if(this._maskedImages.length<1){return AC.Class.Invalidate}},findNewMaskedCanvases:function ac_findNewMaskedCanvases(){var b=AC.Element.selectAll(".ac-masked-img");var a;var c;for(a=0;a<b.length;a+=1){c=b[a];if(this.maskedCanvasElements().indexOf(c)<0){this.maskedCanvasElements().push(c);this.maskedImages().push(new AC.MaskedImage.Image(c))}}}});
